#!/usr/bin/env node
var Gr = require('../index.js'),
    gr = new Gr(),
    fs = require('fs'),
    path = require('path'),
    style = require('../lib/style.js'),
    log = require('minilog')('gr');

require('minilog').enable();

var config = require('../plugins/config.js'),
    tag = require('../plugins/tag.js'),
    status = require('../plugins/status.js');

function version(req) {
  console.log(require('../package.json').version);
  req.exit();
}

function help(req) {
  console.log(fs.readFileSync(__dirname + '/usage.txt').toString());
  req.exit();
}

// middleware: git
/*
gr.use(function(req, res, next) {
  console.log('Ran middleware');
  next();
});
*/

// plugins

gr.use('help', help);
gr.use('--help', help);

gr.use('-v', version);
gr.use('--version', version);
gr.use('version', version);

gr.use('completion', require('../plugins/completion.js'));

// bootstrap plugin ...

// config plugin
gr.use(['config', 'add'], config.add);
gr.use(['config', 'set'], config.set);
gr.use(['config', 'remove'], config.remove);
gr.use(['config', 'rm'], config.remove);
gr.use(['config', 'get'], config.get);
gr.use(['config', 'list'], config.list);
gr.use(['config', 'ls'], config.list);
gr.use(['config'], config.list);

// list plugin
gr.use('list', require('../plugins/list.js'));

// nop plugin
gr.use(['nop'],  require('../plugins/nop.js'));

// status plugin
gr.use(['status'], status);

// tag manipulation
gr.use(['tag', 'add'], tag.add);
gr.use(['tag', 'remove'], tag.remove);
gr.use(['tag', 'rm'], tag.remove);
gr.use(['tag', 'list'], tag.list);
gr.use(['tag', 'ls'], tag.list);
gr.use(['tag', 'discover'], tag.discover);
gr.use(['tag'], tag.list);

// default: run the remainder as a shell task
gr.use('--', require('../plugins/run.js'));
gr.use(require('../plugins/run.js'));

// preprocessing: expand +#tag / -#tag
var argv = gr.preprocess(process.argv.slice(2));
// process.stderr.write(JSON.stringify(argv));

// parse targets
argv = gr.parseTargets(argv);
// process.stderr.write(JSON.stringify(argv));

// #foo #bar => will just output
if(argv.length == 0) {
  if(gr.format == 'json') {
    console.log(JSON.stringify(gr.directories, null, 2));
  } else {
    log.info('Paths', gr.directories);
  }
  return;
}

// execute for each target
gr.exec(argv, function() {
  // console.log('last!');
});
